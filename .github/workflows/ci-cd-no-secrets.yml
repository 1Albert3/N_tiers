name: CI/CD (Sans Secrets)

on:
  push:
    branches: [main, develop, fix/register]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: todo_password
          POSTGRES_USER: todo_user
          POSTGRES_DB: todo_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - uses: actions/checkout@v3
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.3"
          extensions: mbstring, xml, ctype, iconv, intl, pdo_pgsql
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json
      - name: Install Backend Dependencies
        working-directory: ./backend
        run: composer update --no-progress --prefer-dist --optimize-autoloader
      - name: Install Frontend Dependencies
        working-directory: ./frontend
        run: npm install
      - name: Run Backend Tests
        working-directory: ./backend
        run: |
          cp .env.example .env
          php artisan key:generate
          php artisan migrate
          php artisan test
        env:
          DB_CONNECTION: pgsql
          DB_HOST: localhost
          DB_PORT: 5432
          DB_DATABASE: todo_db
          DB_USERNAME: todo_user
          DB_PASSWORD: todo_password
      - name: Run Frontend Tests
        working-directory: ./frontend
        run: npm test -- --coverage --watchAll=false

  security-scan:
    needs: test
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v3
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          format: "table"

  build-images:
    needs: [test, security-scan]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      - name: Build Frontend Image
        uses: docker/build-push-action@v4
        with:
          context: ./frontend
          push: false
          tags: todopro-frontend:demo
          cache-from: type=gha
          cache-to: type=gha,mode=max
      - name: Build Backend Image
        uses: docker/build-push-action@v4
        with:
          context: ./backend
          push: false
          tags: todopro-backend:demo
          cache-from: type=gha
          cache-to: type=gha,mode=max
      - name: Build Database Image
        uses: docker/build-push-action@v4
        with:
          context: ./database-tier
          push: false
          tags: todopro-database:demo
          cache-from: type=gha
          cache-to: type=gha,mode=max

  validate-k8s:
    needs: build-images
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: "v1.28.0"
      - name: Validate Kubernetes manifests
        run: |
          # Validation Kustomize (syntaxe YAML et structure)
          echo "Validating Kustomize configuration..."
          kubectl kustomize k8s/base/ > /tmp/manifests.yaml
          echo "âœ… Kubernetes manifests are valid"
          echo "Generated $(wc -l < /tmp/manifests.yaml) lines of Kubernetes manifests"

  deploy-test:
    needs: validate-k8s
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      - name: Build and Load Images
        run: |
          docker build -t todopro-frontend:test ./frontend
          docker build -t todopro-backend:test ./backend
          docker build -t todopro-database:test ./database-tier
      - name: Start Application
        run: |
          # CrÃ©er un docker-compose pour les tests avec les images prÃ©-construites
          cat > docker-compose.test.yml << 'EOF'
          services:
            frontend:
              image: todopro-frontend:test
              ports:
                - "3000:3000"
              environment:
                - REACT_APP_API_URL=http://localhost:8000/api
              depends_on:
                - backend
              networks:
                - todo-network
          
            backend:
              image: todopro-backend:test
              ports:
                - "8000:8000"
              environment:
                - APP_ENV=local
                - APP_DEBUG=true
                - APP_KEY=base64:YWJjZGVmZ2hpams1bG1ub3BxcnN0dXZ3eHl6MTIzNDU2Nzg5MA==
                - DB_CONNECTION=pgsql
                - DB_HOST=postgres
                - DB_PORT=5432
                - DB_DATABASE=todo_db
                - DB_USERNAME=todo_user
                - DB_PASSWORD=todo_password
                - JWT_SECRET=your-jwt-secret-key-change-this-in-production
              depends_on:
                postgres:
                  condition: service_healthy
              networks:
                - todo-network
          
            postgres:
              image: postgres:15-alpine
              ports:
                - "5432:5432"
              environment:
                - POSTGRES_DB=todo_db
                - POSTGRES_USER=todo_user
                - POSTGRES_PASSWORD=todo_password
              healthcheck:
                test: ["CMD-SHELL", "pg_isready -U todo_user -d todo_db"]
                interval: 10s
                timeout: 5s
                retries: 5
              networks:
                - todo-network
          
          networks:
            todo-network:
              driver: bridge
          EOF
          
          # DÃ©marrer l'application
          docker compose -f docker-compose.test.yml up -d
          
          # Attendre que les services soient prÃªts
          sleep 90
      - name: Test Application
        run: |
          # Test Backend Health
          echo "Testing backend health..."
          curl -f http://localhost:8000/api/health || exit 1
          echo "âœ… Backend is healthy"
          
          # Test Frontend
          echo "Testing frontend..."
          curl -f http://localhost:3000 || exit 1
          echo "âœ… Frontend is accessible"
          
          # Test API Registration (optionnel)
          echo "Testing API registration..."
          curl -X POST http://localhost:8000/api/register \
            -H "Content-Type: application/json" \
            -d '{"name":"Test User","email":"test@example.com","password":"password123","password_confirmation":"password123"}' \
            || echo "âš ï¸ Registration test failed (expected if validation strict)"
          
          echo "ðŸŽ‰ Application is running successfully!"
      - name: Show Logs (if failure)
        if: failure()
        run: |
          echo "=== Backend Logs ==="
          docker compose -f docker-compose.test.yml logs backend
          echo "=== Frontend Logs ==="
          docker compose -f docker-compose.test.yml logs frontend
          echo "=== Database Logs ==="
          docker compose -f docker-compose.test.yml logs postgres
      - name: Cleanup
        if: always()
        run: |
          docker compose -f docker-compose.test.yml down -v || true